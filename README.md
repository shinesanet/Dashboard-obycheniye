import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime

st.set_page_config(page_title="HR –î–∞—à–±–æ—Ä–¥", layout="wide")
st.title("üìä HR-–¥–∞—à–±–æ—Ä–¥ –ø–æ –æ–±—É—á–µ–Ω–∏—é —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤")

uploaded_file = st.file_uploader("‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª —Å–æ —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π", type=["xlsx"])

if uploaded_file:
    df = pd.read_excel(uploaded_file, skiprows=3)

    # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –Ω—É–∂–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
    df = df.rename(columns={
        "Unnamed: 1": "–§–ò–û",
        "Unnamed: 2": "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç",
        "Unnamed: 3": "–û—Ç–¥–µ–ª",
        "Unnamed: 4": "–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è",
        "Unnamed: 5": "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è",
        "Unnamed: 45": "–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª",
        "Unnamed: 46": "–°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è",
        "Unnamed: 44": "–ü–æ—Å–µ—â–µ–Ω–∏–µ –ú–ü–ü"
    })

    # –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
    df["–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è"] = pd.to_datetime(df["–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è"], errors="coerce")
    df["–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"] = pd.to_datetime(df["–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"], errors="coerce")

    # ‚ñë‚ñë‚ñë –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ‚ñë‚ñë‚ñë
    st.sidebar.header("üîç –§–∏–ª—å—Ç—Ä—ã")
    dep_filter = st.sidebar.multiselect("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç", df["–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"].dropna().unique())
    div_filter = st.sidebar.multiselect("–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª", df["–û—Ç–¥–µ–ª"].dropna().unique())
    status_filter = st.sidebar.multiselect("–°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è", df["–°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è"].dropna().unique())

    filtered_df = df.copy()
    if dep_filter:
        filtered_df = filtered_df[filtered_df["–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"].isin(dep_filter)]
    if div_filter:
        filtered_df = filtered_df[filtered_df["–û—Ç–¥–µ–ª"].isin(div_filter)]
    if status_filter:
        filtered_df = filtered_df[filtered_df["–°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è"].isin(status_filter)]

    st.success("‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã")

    # ‚ñë‚ñë‚ñë –°–í–û–î–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ‚ñë‚ñë‚ñë
    st.header("üìå –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
    col1, col2, col3 = st.columns(3)
    col1.metric("üë• –í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤", len(filtered_df))
    col2.metric("‚úÖ –ó–∞–≤–µ—Ä—à–∏–ª–∏ –æ–±—É—á–µ–Ω–∏–µ", filtered_df["–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"].notna().sum())
    col3.metric("üìà –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª", round(filtered_df["–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª"].mean(skipna=True), 1))

    # ‚ñë‚ñë‚ñë –ö–†–£–ì–û–í–ê–Ø –î–ò–ê–ì–†–ê–ú–ú–ê –ü–û –°–¢–ê–¢–£–°–ê–ú ‚ñë‚ñë‚ñë
    st.header("üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –æ–±—É—á–µ–Ω–∏—è")
    status_counts = filtered_df["–°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è"].value_counts().reset_index()
    status_counts.columns = ["–°—Ç–∞—Ç—É—Å", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"]
    fig = px.pie(status_counts, values="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", names="–°—Ç–∞—Ç—É—Å", title="–°—Ç–∞—Ç—É—Å—ã –æ–±—É—á–µ–Ω–∏—è", hole=0.4)
    st.plotly_chart(fig, use_container_width=True)

    # ‚ñë‚ñë‚ñë –ë–ê–õ–õ–´ –ü–û –û–ë–£–ß–ï–ù–ò–Æ ‚ñë‚ñë‚ñë
    st.header("üéØ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–∏—Ö –±–∞–ª–ª–æ–≤")
    st.bar_chart(filtered_df["–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª"])

    # ‚ñë‚ñë‚ñë –¢–ê–ë–õ–ò–¶–ê –°–û–¢–†–£–î–ù–ò–ö–û–í ‚ñë‚ñë‚ñë
    st.header("üìã –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º")
    st.dataframe(filtered_df[["–§–ò–û", "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç", "–û—Ç–¥–µ–ª", "–°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è", "–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª", "–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è", "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"]])

    # ‚ñë‚ñë‚ñë –ú–ü–ü: –¢–û–õ–¨–ö–û –î–õ–Ø –ö–û–ú–ú–ï–†–ß–ï–°–ö–û–ì–û –î–ï–ü–ê–†–¢–ê–ú–ï–ù–¢–ê ‚ñë‚ñë‚ñë
    st.header("üè≠ –ü–æ—Å–µ—â–µ–Ω–∏–µ –ú–ü–ü (—Ç–æ–ª—å–∫–æ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç)")
    df_mpp = filtered_df[filtered_df["–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç"].str.lower().str.contains("–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π", na=False)]

    if not df_mpp.empty:
        total_mpp = df_mpp["–ü–æ—Å–µ—â–µ–Ω–∏–µ –ú–ü–ü"].notna().sum()
        passed_mpp = df_mpp["–ü–æ—Å–µ—â–µ–Ω–∏–µ –ú–ü–ü"].str.contains("–ø—Ä–æ–π–¥–µ–Ω", case=False, na=False).sum()
        st.metric("üßæ –ù–∞–∑–Ω–∞—á–µ–Ω–æ –Ω–∞ –ú–ü–ü", total_mpp)
        st.metric("‚úÖ –ó–∞–≤–µ—Ä—à–∏–ª–∏ –ú–ü–ü", passed_mpp)
        if total_mpp > 0:
            st.metric("üìä –ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è", f"{round(passed_mpp / total_mpp * 100, 1)}%")
    else:
        st.info("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞")

    # ‚ñë‚ñë‚ñë –¢–ï–°–¢–´: –£–°–ü–ï–í–ê–ï–ú–û–°–¢–¨ ‚ñë‚ñë‚ñë
    st.header("üß™ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ—Å—Ç–∞–º")
    st.write("‚ö†Ô∏è –ó–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ—Ä–∞–±–æ—Ç–∫–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ–ø—ã—Ç–æ–∫ ‚Äî –ø–æ–∫–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ –ª—É—á—à–µ–π –ø–æ–ø—ã—Ç–∫–µ (—Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª)")

    best = filtered_df["–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª"].dropna()
    st.metric("üß† –ü—Ä–æ—à–ª–∏ —Å 1 –ø–æ–ø—ã—Ç–∫–∏ (–æ—Ü–µ–Ω–∫–∞ ‚â• 85)", (best >= 85).sum())
    st.metric("üìâ –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ –≤—Å–µ–º", round(best.mean(), 1))

    # ‚ñë‚ñë‚ñë –î–ò–ù–ê–ú–ò–ö–ê –û–ë–£–ß–ï–ù–ò–Ø ‚ñë‚ñë‚ñë
    st.header("üìÜ –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏—è")
    timeline = filtered_df[filtered_df["–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"].notna()]
    timeline = timeline.groupby(timeline["–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"].dt.to_period("M")).size().reset_index(name="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ")
    timeline["–î–∞—Ç–∞"] = timeline["–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"].astype(str)

    fig_line = px.line(timeline, x="–î–∞—Ç–∞", y="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", markers=True, title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –æ–±—É—á–µ–Ω–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º")
    st.plotly_chart(fig_line, use_container_width=True)

    # ‚ñë‚ñë‚ñë –î–ê–¢–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø ‚ñë‚ñë‚ñë
    st.caption(f"üìÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: {datetime.now().strftime('%d.%m.%Y %H:%M')}")

else:
    st.warning("–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–∞.")
